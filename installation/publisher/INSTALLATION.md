# ðŸ‘©â€ðŸ’» Publisher Technical Implementation (The "How")

**What you need:**
*   `@imagxp/protocol`: The Logic Engine.
*   `jose`: **Why?** It handles the sophisticated "JSON Web Signatures" (JWS) needed for the court-proof logging.
*   `uuid`: **Why?** Creates unique Trace IDs for every single request so you can debug "that one time it failed".

## Step 1: Install
```bash
npm install @imagxp/protocol
npm install jose uuid
```

## Step 1.5: Environment Variables (.env)
Create a `.env` file in your root directory. This ensures your Publisher Identity is persistent.

```bash
# .env
# 1. Your Publisher Identity (Generate via `npx imagxp generate-identity`)
IMAGXP_PRIVATE_KEY="MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEH..."
IMAGXP_PUBLIC_KEY="MFKwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE..."
```

## Step 1.6: Public Identity (`public/.well-known/imagxp-agent.json`)
You must host your Public Key so Brokers and Agents can verify you.
Create a file at `public/.well-known/imagxp-agent.json`:

```json
{
  "agent_id": "your-site.com",
  "public_key": "MFKwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...",
  "contact": "admin@your-site.com",
  "version": "1.0"
}
```


## Step 2: The Gatekeeper (`src/middleware.ts`)
This code acts as a "Bouncer". It intercepts requests and runs the flow described above (Steps A-C).

```typescript
// src/middleware.ts
import { NextResponse } from 'next/server';
import { IMAGXPNext } from '@imagxp/protocol';

// Initialize the Protocol Engine
const imagxp = IMAGXPNext.init({
    meta: { 
        origin: 'HUMAN',             // Claim: "My content is human-written" 
        paymentPointer: '$wallet'    // Your direct payment address
    },
    policy: {
        // [SECURITY] STRICT IDENTIFICATION
        // Stops "Fake DNS" spoofing. We verify the Agent's Public Key matches their Domain.
        requireIdentityBinding: true, 

        // [ECONOMICS]
        requiresPayment: true,       // "Agents must pay or get blocked"
        
        // [PERMISSIONS]
        allowTraining: false,        // "Block Scrapers"
        allowRAG: true               // "Allow Search Engines"
    },
    strategy: 'HYBRID'               // "Allow Humans (Browsers) + Verified Agents"
});

// Protect specific routes (e.g. /posts, /articles)
export async function middleware(req) {
    if (req.nextUrl.pathname.startsWith('/posts')) {
        return imagxp.withProtection(async (req) => NextResponse.next())(req);
    }
    return NextResponse.next();
}
```

## Step 3: The Dashboard (Admin Only)
**Warning**: This dashboard contains Sensitive Logs. You **MUST** protect it.
*   **Safety**: Use Basic Auth or your existing Login system.
*   **Legal Proof**: The logs shown here prove *exactly* who accessed your data, signed with their private key.

*(Note: The Dashboard UI is auto-generated by the SDK at `/imagxp/dashboard` if configured).*

## Data Retention Strategy (Costs & Compliance)

**For Small Publishers (Low Cost)**
*   **Strategy**: "Ephemeral Logs".
*   **Cost**: $0.
*   **How**: Rely on Vercel/Netlify Logs (kept for 1-7 days). This is enough to check "Who scraped me yesterday?".
*   **IP Compliance**: The `middleware.ts` logs `req.ip` to the hosting provider's console automatically.

**For Enterprise (High Compliance)**
*   **Strategy**: "Log Shipping".
*   **Cost**: Database Storage Fees.
*   **How**: Modify your `src/app/api/logs/stream/route.ts` to `INSERT` logs into PostgreSQL/S3.
*   **Why**: Required for 7-year audit trails in regulated industries.

## Clean Project Structure
**"Where does the code go?"**
In a standard Next.js app, imagxp adds exactly **3 files**.

```text
my-web-app/
â”œâ”€â”€ .env                  <-- API Keys (Private Key)
â”œâ”€â”€ public/
â”‚   â””â”€â”€ .well-known/
â”‚       â””â”€â”€ imagxp-agent.json  <-- Identity File (Part 1)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ middleware.ts        <-- The Gatekeeper (Part 2)
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ api/
â”‚           â””â”€â”€ logs/
â”‚               â””â”€â”€ stream/
â”‚                   â””â”€â”€ route.ts  <-- The Logs (Part 3)
```
